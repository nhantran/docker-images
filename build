#!/bin/bash

usage()
{
cat << EOF
usage: $0 options

This script is to build Docker images for a CI/CD system.

OPTIONS:
   -h      Show this message
   -n      Image name, is also the folder name of subfolders of docker-images
   -i      Software repository IP, where hosting offline softwares
EOF
}

IMAGE_NAME=
SOFT_REPO_IP=172.17.42.1

JENKINS_VERSION=1.549
JK_GIT_CLIENT_VERSION=1.10.0
JK_SCM_API_VERSION=0.2
JK_GIT_VERSION=2.2.2
JK_ARTIFACTORY_VERSION=2.2.3
JK_SONAR_VERSION=2.1

SONARQUBE_VERSION=4.1.2

ARTIFACTORY_VERSION=3.2.2

GITLAB_FQDN=gitlab
GITLAB_EMAIL_FROM=tranphanquocnhan@gmail.com

CASSANDRA_VERSION=2.0.9
JNA_VERSION=4.1.0

while getopts “hn:i:” OPTION
do
     case $OPTION in
         h)
             usage
             exit 1
             ;;
         n)
             IMAGE_NAME=$OPTARG
             ;;
         i)
             SOFT_REPO_IP=$OPTARG
             ;;
         ?)
             usage
             exit
             ;;
     esac
done
 
sed -r -e "s/\{\{SOFT_REPO_IP\}\}/$SOFT_REPO_IP/g" $IMAGE_NAME/Dockerfile.template > $IMAGE_NAME/Dockerfile
sed -i -e "s/{{JENKINS_VERSION}}/$JENKINS_VERSION/g" $IMAGE_NAME/Dockerfile
sed -i -e "s/{{JK_GIT_CLIENT_VERSION}}/$JK_GIT_CLIENT_VERSION/g" $IMAGE_NAME/Dockerfile
sed -i -e "s/{{JK_SCM_API_VERSION}}/$JK_SCM_API_VERSION/g" $IMAGE_NAME/Dockerfile
sed -i -e "s/{{JK_GIT_VERSION}}/$JK_GIT_VERSION/g" $IMAGE_NAME/Dockerfile
sed -i -e "s/{{JK_ARTIFACTORY_VERSION}}/$JK_ARTIFACTORY_VERSION/g" $IMAGE_NAME/Dockerfile
sed -i -e "s/{{JK_SONAR_VERSION}}/$JK_SONAR_VERSION/g" $IMAGE_NAME/Dockerfile

sed -i -e "s/{{SONARQUBE_VERSION}}/$SONARQUBE_VERSION/g" $IMAGE_NAME/Dockerfile

sed -i -e "s/{{ARTIFACTORY_VERSION}}/$ARTIFACTORY_VERSION/g" $IMAGE_NAME/Dockerfile

sed -i -e "s/{{GITLAB_FQDN}}/$GITLAB_FQDN/g" $IMAGE_NAME/Dockerfile
sed -i -e "s/{{GITLAB_EMAIL_FROM}}/$GITLAB_EMAIL_FROM/g" $IMAGE_NAME/Dockerfile

sed -i -e "s/{{CASSANDRA_VERSION}}/$CASSANDRA_VERSION/g" $IMAGE_NAME/Dockerfile
sed -i -e "s/{{JNA_VERSION}}/$JNA_VERSION/g" $IMAGE_NAME/Dockerfile

#sed -i -e 's|^RUN |RUN export http_proxy=http://192.168.15.39:3127 \&\& |g' $IMAGE_NAME/Dockerfile  

cat $IMAGE_NAME/Dockerfile

docker build -t nhantran/$IMAGE_NAME $IMAGE_NAME/

# Cleanup temporary files
rm -f $IMAGE_NAME/Dockerfile
